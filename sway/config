# WAYLAND_DISPLAY and XDG_CURRENT_DESKTOP=sway are required for screencast to work (xdg-desktop-portal-wlr requires it)
# without WAYLAND_DISPLAY waybar takes 10+ seconds to start
# without DISPLAY GTK apps take 20+ seconds to start
exec_always dbus-update-activation-environment --systemd DISPLAY WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=sway

input type:keyboard {
    xkb_layout "pl"
    repeat_delay 250
    repeat_rate 40
}
input type:pointer {
    scroll_factor 2
}
input type:touchpad {
    tap enabled
}

# <<output laptop>

# <<output external monitor>>

output * bg $HOME/.config/sway/wallpaper.jpg fill

font Hack 10
font Ubuntu Mono 12

bar {
    # swaybar_command is run directly without shell, so we cannot use $HOME etc.
    swaybar_command .config/waybar/run-waybar.sh
}

bindsym --no-repeat Ctrl+Alt+r reload

set $if_bose_headphones_then_4_else_1 $(wpctl inspect @DEFAULT_SINK@ | grep '^\s*\*\s*node.name = "bluez_output.4C_87_5D_07_5B_C4' --quiet && echo 4 || echo 1)
set $if_bose_headphones_then_4_else_5 $(wpctl inspect @DEFAULT_SINK@ | grep '^\s*\*\s*node.name = "bluez_output.4C_87_5D_07_5B_C4' --quiet && echo 4 || echo 5)
bindsym XF86AudioRaiseVolume exec wpctl set-volume --limit 1 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_5%+
bindsym XF86AudioLowerVolume exec wpctl set-volume --limit 1 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_5%-
bindsym Ctrl+XF86AudioRaiseVolume exec wpctl set-volume --limit 1 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_1%+
bindsym Ctrl+XF86AudioLowerVolume exec wpctl set-volume --limit 1 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_1%-
bindsym Shift+XF86AudioRaiseVolume exec wpctl set-volume --limit 1 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_1%+
bindsym Shift+XF86AudioLowerVolume exec wpctl set-volume --limit 1 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_1%-
bindsym Ctrl+Alt+equal exec wpctl set-volume --limit 1 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_5%+
bindsym Ctrl+Alt+minus exec wpctl set-volume --limit 1 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_5%-
bindsym Ctrl+Alt+Shift+equal exec wpctl set-volume --limit 2 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_1%+
bindsym Ctrl+Alt+Shift+minus exec wpctl set-volume --limit 2 @DEFAULT_SINK@ $if_bose_headphones_then_4_else_1%-
bindsym --no-repeat --locked Ctrl+Alt+asterisk exec wpctl set-mute @DEFAULT_SINK@ toggle
bindsym --no-repeat --locked XF86AudioMute exec wpctl set-mute @DEFAULT_SINK@ toggle
bindsym --no-repeat XF86AudioMicMute exec wpctl set-mute @DEFAULT_SOURCE@ toggle
bindsym --no-repeat Ctrl+Alt+Shift+asterisk exec wpctl set-mute @DEFAULT_SOURCE@ toggle
bindsym --locked XF86MonBrightnessDown exec brightnessctl set 2%-
bindsym --locked XF86MonBrightnessUp exec brightnessctl set 2%+
bindsym --no-repeat XF86AudioPause exec waybar-mpris --send toggle
bindsym --no-repeat XF86AudioPlay exec waybar-mpris --send toggle
bindsym XF86AudioNext exec waybar-mpris --send next
bindsym XF86AudioPrev exec waybar-mpris --send prev
bindsym --no-repeat XF86Display exec wdisplays
bindsym XF86PowerOff exec wlogout
bindsym --no-repeat XF86Bluetooth exec "$HOME/.config/sway/toggle_bluetooth.sh"
bindsym --no-repeat XF86Favorites exec waybar-mpris --send toggle

set $lock_screen "$HOME/.config/sway/lock_screen.sh"
set $lock_screen_if_no_external_display "$HOME/.config/sway/lock_screen_if_no_external_display.sh"

exec swayidle -w \
    timeout 300 '$lock_screen' \
    timeout 310 'swaymsg "output * power off"' resume 'swaymsg "output * power on"' \
    before-sleep '$lock_screen' \
    after-resume 'until bluetoothctl power on; do sleep 0.1; done'

# Lock the screen on lid close (even if not going to suspend), but do not lock screen when sway is started with the lid closed
# (lid:on are triggered if sway starts with the closed lid, but lid:off is not triggered if sway starts with the open lid)
exec swaymsg bindswitch lid:on exec '$lock_screen_if_no_external_display'

bindsym --no-repeat Ctrl+Alt+l exec '$lock_screen'
bindsym --no-repeat --release --locked Ctrl+Alt+s exec systemctl suspend

bindsym --no-repeat Ctrl+Alt+Delete exec wlogout
bindsym --no-repeat Ctrl+Alt+t exec alacritty msg create-window --working-directory "$HOME" || alacritty --working-directory "$HOME"
bindsym --no-repeat Ctrl+Alt+f exec firefox
bindsym --no-repeat Mod4+s exec subl --launch-or-new-window
bindsym --no-repeat Mod4+k exec keepassxc
# Kill focused window
bindsym Ctrl+Alt+k kill
bindsym Ctrl+Shift+w kill
# Launcher
bindsym --no-repeat Ctrl+Alt+d exec kickoff

bindsym --no-repeat Ctrl+Alt+w exec alacritty msg create-window --title=connect-to-wifi -e sh -c $HOME/.local/bin/connect-to-wifi.sh || alacritty --title=connect-to-wifi -e sh -c $HOME/.local/bin/connect-to-wifi.sh
for_window [app_id="^Alacritty" title="^connect-to-wifi"] floating enable

bindsym --no-repeat Ctrl+Alt+b exec alacritty msg create-window --title=connect-bluetooth -e sh -c $HOME/.local/bin/connect-bluetooth.sh || alacritty --title=connect-bluetooth -e sh -c $HOME/.local/bin/connect-bluetooth.sh
for_window [app_id="^Alacritty" title="^connect-bluetooth"] floating enable

for_window [app_id="^zoom$"] floating enable
for_window [app_id="^zoom$" title="^Zoom Meeting$"] floating disable

floating_modifier Alt normal

# Preserve clipboard (standard and primary) after the application quits
# exec 'until [ "$(systemctl --user is-active clipmon)" = "active" ]; do systemctl --user start clipmon; sleep 0.1; done'

exec 'until bluetoothctl power on; do sleep 0.1; done'
exec nm-applet --indicator
# Blueman-applet silently fails for some time after sway startup
exec 'sleep 0.5; exec blueman-applet'
# Maestral (open-source Dropbox client)
exec maestral gui

# Arrange and navigate workspaces as layered 2D grids
exec "$HOME/.config/sway/sway-workspace-switcher 2>&1 > $HOME/.config/sway/sway-workspace-switcher.log"
set $workspace_switcher_pipe "$HOME/.config/sway/sway-workspace-switcher.pipe"

bindsym Ctrl+Alt+Up exec echo "go up" > $workspace_switcher_pipe
bindsym Ctrl+Alt+Down exec echo "go down" > $workspace_switcher_pipe
bindsym Ctrl+Alt+Left exec echo "go left" > $workspace_switcher_pipe
bindsym Ctrl+Alt+Right exec echo "go right" > $workspace_switcher_pipe
bindsym Ctrl+Alt+n exec echo "go to next layer" > $workspace_switcher_pipe
bindsym Ctrl+Alt+c exec echo "go to new layer" > $workspace_switcher_pipe

bindsym Ctrl+Alt+Shift+Up exec echo "carry up" > $workspace_switcher_pipe
bindsym Ctrl+Alt+Shift+Down exec echo "carry down" > $workspace_switcher_pipe
bindsym Ctrl+Alt+Shift+Left exec echo "carry left" > $workspace_switcher_pipe
bindsym Ctrl+Alt+Shift+Right exec echo "carry right" > $workspace_switcher_pipe
bindsym Ctrl+Alt+Shift+n exec echo "carry to next layer" > $workspace_switcher_pipe
bindsym Ctrl+Alt+Shift+c exec echo "carry to new layer" > $workspace_switcher_pipe

bindsym Ctrl+Alt+h exec "$HOME/.config/sway/sway-focus-switcher" next
bindsym Ctrl+Shift+Alt+h exec "$HOME/.config/sway/sway-focus-switcher" prev

# Screenshots
bindsym --no-repeat Print exec mkdir -p -m 700 /tmp/screenshots/ && grim - | tee "$(date '+/tmp/screenshots/%F %T.png')" | wl-copy
bindsym --no-repeat Ctrl+Print exec mkdir -p -m 700 /tmp/screenshots/ && grim -g "$(slurp -d)" - | tee "$(date '+/tmp/screenshots/%F %T.png')" | wl-copy

# Notifications
exec mako

hide_edge_borders both

bindsym --no-repeat Ctrl+Alt+F11 fullscreen toggle

bindsym Ctrl+Alt+Shift+f floating toggle
# window_role is the title of an X11 (Xwayland) window (name field reported by swaymsg -t get_tree)
for_window [window_role="pop-up"] floating enable
for_window [window_role="Pop-up"] floating enable
for_window [window_role="bubble"] floating enable
for_window [window_role="Bubble"] floating enable
for_window [window_role="dialog"] floating enable
for_window [window_role="Dialog"] floating enable
for_window [window_type="dialog"] floating enable
for_window [window_type="Dialog"] floating enable
for_window [class="dialog"] floating enable
for_window [class="Dialog"] floating enable
for_window [window_role="task_dialog"] floating enable
for_window [window_type="menu"] floating enable
for_window [window_role="About"] floating enable
for_window [app_id="nm-connection-editor"] floating enable

for_window [app_id="firefox" title="Firefox .*â€” Sharing Indicator"] floating enable, sticky enable, border normal, resize set height 54 px, border none, move absolute position 0 0
for_window [app_id="firefox"] border none
for_window [app_id="anki"] floating enable
for_window [app_id="ssh-askpass-sublime"] floating enable

bindsym --no-repeat Ctrl+Alt+Shift+w exec LC_ALL=en_US.UTF-8 horizon-client --tokenUserName=malysakr
for_window [shell="xwayland" class="Horizon-client" title=^VDI_W11$] floating enable, exec sleep 4 && swaymsg '[shell="xwayland" class="Horizon-client" title=^VDI_W11$] floating disable' && swaymsg '[shell="xwayland" class="Horizon-client" title="^Omnissa Horizon Client$"] kill'

# Exit sway (logs you out of your Wayland session)
bindsym Ctrl+Alt+Shift+e exec swaynag -t warning -m 'You pressed the exit shortcut. Do you really want to exit sway? This will end your Wayland session.' -b 'Yes, exit sway' 'swaymsg exit'

# Warn about dotfiles change
exec "$HOME/.config/sway/warn_about_dotfiles_change.sh"

# Enable custom per-application key remaps
exec keyd-application-mapper --daemonize

bindsym --no-repeat Ctrl+Alt+q [con_id=__focused__ app_id=^BeeperTexts$] kill, exec pkill -x beepertexts && sleep 1 && pkill -KILL -x beepertexts
